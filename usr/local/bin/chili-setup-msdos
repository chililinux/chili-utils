#!/usr/bin/env bash
# -*- coding: utf-8 -*-
# shellcheck shell=bash disable=SC1091,SC2039,SC2166
#
#  chili-setup-msdos
#  Created: 2025/08/04 - 00:38
#  Altered: 2025/08/04 - 00:38
#
#  Copyright (c) 2025-2025, Vilmar Catafesta <vcatafesta@gmail.com>
#  All rights reserved.
#
#  Redistribution and use in source and binary forms, with or without
#  modification, are permitted provided that the following conditions
#  are met:
#  1. Redistributions of source code must retain the above copyright
#     notice, this list of conditions and the following disclaimer.
#  2. Redistributions in binary form must reproduce the above copyright
#     notice, this list of conditions and the following disclaimer in the
#     documentation and/or other materials provided with the distribution.
#
#  THIS SOFTWARE IS PROVIDED BY Vilmar Catafesta ''AS IS'' AND ANY EXPRESS OR
#  IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
#  OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
#  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
#  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
#  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
#  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
#  THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
#  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
#  THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
##############################################################################
#export LANGUAGE=pt_BR
export TEXTDOMAINDIR=/usr/share/locale
export TEXTDOMAIN=chili-setup-msdos

# Definir a vari√°vel de controle para restaurar a formata√ß√£o original
reset=$(tput sgr0)

# Definir os estilos de texto como vari√°veis
bold=$(tput bold)
underline=$(tput smul)   # In√≠cio do sublinhado
nounderline=$(tput rmul) # Fim do sublinhado
reverse=$(tput rev)      # Inverte as cores de fundo e texto

# Definir as cores ANSI como vari√°veis
black=$(tput bold)$(tput setaf 0)
red=$(tput bold)$(tput setaf 196)
green=$(tput bold)$(tput setaf 2)
yellow=$(tput bold)$(tput setaf 3)
blue=$(tput setaf 4)
pink=$(tput setaf 5)
magenta=$(tput setaf 5)
cyan=$(tput setaf 6)
white=$(tput setaf 7)
gray=$(tput setaf 8)
orange=$(tput setaf 202)
purple=$(tput setaf 125)
violet=$(tput setaf 61)
light_red=$(tput setaf 9)
light_green=$(tput setaf 10)
light_yellow=$(tput setaf 11)
light_blue=$(tput setaf 12)
light_magenta=$(tput setaf 13)
light_cyan=$(tput setaf 14)
bright_white=$(tput setaf 15)

#debug
export PS4='${red}${0##*/}${green}[$FUNCNAME]${pink}[$LINENO]${reset}'
#set -x
#set -e
shopt -s extglob

#system
declare APP="${0##*/}"
declare _VERSION_="1.0.0-20250804"
declare APPDESC="bash - Wraper for "
declare distro="$(uname -n)"
declare DEPENDENCIES=(tput)
declare dialogRcFile="/home/vcatafesta/.dialogrc"

cleanup() { rm -f ""; }
#trap cleanup EXIT
MostraErro() { echo "erro: ${red}$1${reset} => comando: ${cyan}'$2'${reset} => result=${yellow}$3${reset}";}
trap 'MostraErro "$APP[$FUNCNAME][$LINENO]" "$BASH_COMMAND" "$?"; exit 1' ERR

sh_create_dialogrc() {
  cat > "$dialogRcFile" <<EOF_DIALOGRC
screen_color = (white,black,off)
dialog_color = (white,black,off)
title_color = (cyan,black,on)
border_color = dialog_color
shadow_color = (black,black,on)
button_inactive_color = dialog_color
button_key_inactive_color = dialog_color
button_label_inactive_color = dialog_color
button_active_color = (white,cyan,on)
button_key_active_color = button_active_color
button_label_active_color = (black,cyan,on)
tag_key_selected_color = (white,cyan,on)
item_selected_color = tag_key_selected_color
form_text_color = (BLUE,black,ON)
form_item_readonly_color = (green,black,on)
itemhelp_color = (white,cyan,off)
inputbox_color = dialog_color
inputbox_border_color = dialog_color
searchbox_color = dialog_color
searchbox_title_color = title_color
searchbox_border_color = border_color
position_indicator_color = title_color
menubox_color = dialog_color
menubox_border_color = border_color
item_color = dialog_color
tag_color = title_color
tag_selected_color = button_label_active_color
tag_key_color = button_key_inactive_color
check_color = dialog_color
check_selected_color = button_active_color
uarrow_color = screen_color
darrow_color = screen_color
form_active_text_color = button_active_color
gauge_color = title_color
border2_color = dialog_color
searchbox_border2_color = dialog_color
menubox_border2_color = dialog_color
separate_widget = ''
tab_len = 0
visit_items = off
use_shadow = off
use_colors = on
EOF_DIALOGRC
  export DIALOGRC="$dialogRcFile"
}

# Testa se o terminal suporta caracteres gr√°ficos estendidos
sh_ascii_lines() {
  #Isso for√ßa o dialog a usar caracteres ASCII b√°sicos para as bordas.
  #if [[ "$LANG" =~ 'UTF-8' ]]; then
  if [[ "$(printf '\u250C')" =~ "‚îå" ]]; then
    export NCURSES_NO_UTF8_ACS=1  # Terminal suporta ACS
  else
    export NCURSES_NO_UTF8_ACS=0  # Terminal N√ÉO suporta ACS
  fi
  }

sh_setEnvironment() {
  [[ ! -e "$dialogRcFile" ]] && sh_create_dialogrc
  sh_ascii_lines
}

#!/bin/bash
set -e

# Cores
RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
BLUE="\033[34m"
CYAN="\033[36m"
RESET="\033[0m"

DISK_DIR="msdos"
DISK1="$DISK_DIR/disk1.img"
DISK2="$DISK_DIR/disk2.img"
DISK3="$DISK_DIR/disk3.img"
DISK_IMG="$DISK_DIR/msdos622.img"
DISK_SIZE="200M"
MSDOS_URL="https://dl-alt1.winworldpc.com/Microsoft%20MS-DOS%206.22%20[Brazilian-Portuguese]%20(3.5).7z"
MSDOS_ARCHIVE="$DISK_DIR/msdos622.7z"

function baixar_msdos() {
  local TMPDIR="temp_extract_dir"

  mkdir -p msdos
  rm -rf "$TMPDIR"
  mkdir "$TMPDIR"

  if [ ! -f "msdos/msdos622.7z" ]; then
    echo -e "${GREEN}‚¨áÔ∏è Baixando MS-DOS 6.22 PT-BR...${RESET}"
    wget -c "$MSDOS_URL" -O msdos/msdos622.7z
  else
    echo -e "${YELLOW}Arquivo j√° existe: msdos/msdos622.7z${RESET}"
  fi

  if ! command -v 7z >/dev/null 2>&1; then
    echo -e "${RED}Erro: '7z' n√£o instalado. Instale p7zip-full.${RESET}"
    exit 1
  fi

  echo -e "${GREEN}üóúÔ∏è Extraindo em pasta tempor√°ria...${RESET}"
  7z x msdos/msdos622.7z -o"$TMPDIR" -y

  echo -e "${GREEN}üìÅ Copiando arquivos para pasta msdos/ sem remover a pasta gigante...${RESET}"
  cp -v "$TMPDIR"/Microsoft\ MS-DOS\ 6.22\ \[Brazilian-Portuguese\]\ \(3.5\)/* msdos/

  echo -e "${GREEN}‚úîÔ∏è Extra√ß√£o e c√≥pia conclu√≠das!${RESET}"
}

function instalar() {
  if [ ! -f "$DISK_IMG" ]; then
    echo -e "${YELLOW}üíΩ Criando imagem de disco $DISK_IMG...${RESET}"
    qemu-img create -f raw "$DISK_IMG" "$DISK_SIZE"
  fi

  if [ ! -f "$DISK1" ] || [ ! -f "$DISK2" ] || [ ! -f "$DISK3" ]; then
    echo -e "${RED}Erro: arquivos de disquete n√£o encontrados em '$DISK_DIR'.${RESET}"
    echo -e "Use a op√ß√£o 0 para baixar ou verifique os arquivos."
    exit 1
  fi

  echo -e "${GREEN}üöÄ Iniciando instala√ß√£o do MS-DOS...${RESET}"
  echo -e "${CYAN}‚ö†Ô∏è Quando o instalador pedir para trocar disquete, use o terminal QEMU para digitar:${RESET}"
  echo -e "${CYAN}  change floppy0 $DISK2${RESET}"
  echo -e "${CYAN}e depois:${RESET}"
  echo -e "${CYAN}  change floppy0 $DISK3${RESET}"
  echo -e "${YELLOW}Pressione Enter para continuar...${RESET}"
  read -r

  qemu-system-i386 \
    -m 16 \
    -hda "$DISK_IMG" \
    -fda "$DISK1" \
    -boot a \
    -net none \
    -vga std \
    -display gtk \
    -monitor stdio
}

function rodar() {
  if [ ! -f "$DISK_IMG" ]; then
    echo -e "${RED}‚ùå Imagem do disco n√£o encontrada. Primeiro instale o MS-DOS.${RESET}"
    exit 1
  fi

  echo -e "${GREEN}‚ñ∂Ô∏è Rodando MS-DOS instalado...${RESET}"
  qemu-system-i386 \
    -m 16 \
    -hda "$DISK_IMG" \
    -boot c \
    -net none \
    -vga std \
    -display gtk
}

while true; do
  echo -e "${BLUE}\n=== MS-DOS Manager ===${RESET}"
  echo -e "${YELLOW}0) Baixar MS-DOS 6.22 PT-BR (.7z)${RESET}"
  echo -e "${YELLOW}1) Instalar MS-DOS (com disquetes)${RESET}"
  echo -e "${YELLOW}2) Rodar MS-DOS instalado (boot do disco)${RESET}"
  echo -e "${YELLOW}3) Sair${RESET}"
  echo -ne "${CYAN}Escolha uma op√ß√£o: ${RESET}"
  read -r opcao

  case "$opcao" in
    0) baixar_msdos ;;
    1) instalar ;;
    2) rodar ;;
    3) echo -e "${GREEN}At√© mais!${RESET}"; exit 0 ;;
    *) echo -e "${RED}Op√ß√£o inv√°lida. Tente novamente.${RESET}" ;;
  esac
done
