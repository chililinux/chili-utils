#!/usr/bin/env bash
# -*- coding: utf-8 -*-
# shellcheck shell=bash disable=SC1091,SC2039,SC2166
#
#  chili-create-zram-disk
#  Created: 2025/08/13 - 18:57
#  Altered: 2025/08/13 - 18:57
#
#  Copyright (c) 2025-2025, Vilmar Catafesta <vcatafesta@gmail.com>
#  All rights reserved.
#
#  Redistribution and use in source and binary forms, with or without
#  modification, are permitted provided that the following conditions
#  are met:
#  1. Redistributions of source code must retain the above copyright
#     notice, this list of conditions and the following disclaimer.
#  2. Redistributions in binary form must reproduce the above copyright
#     notice, this list of conditions and the following disclaimer in the
#     documentation and/or other materials provided with the distribution.
#
#  THIS SOFTWARE IS PROVIDED BY Vilmar Catafesta ''AS IS'' AND ANY EXPRESS OR
#  IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
#  OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
#  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
#  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
#  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
#  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
#  THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
#  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
#  THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
##############################################################################
#export LANGUAGE=pt_BR
export TEXTDOMAINDIR=/usr/share/locale
export TEXTDOMAIN=chili-create-zram-disk

# Definir a vari√°vel de controle para restaurar a formata√ß√£o original
reset=$(tput sgr0)

# Definir os estilos de texto como vari√°veis
bold=$(tput bold)
underline=$(tput smul)   # In√≠cio do sublinhado
nounderline=$(tput rmul) # Fim do sublinhado
reverse=$(tput rev)      # Inverte as cores de fundo e texto

# Definir as cores ANSI como vari√°veis
black=$(tput bold)$(tput setaf 0)
red=$(tput bold)$(tput setaf 196)
green=$(tput bold)$(tput setaf 2)
yellow=$(tput bold)$(tput setaf 3)
blue=$(tput setaf 4)
pink=$(tput setaf 5)
magenta=$(tput setaf 5)
cyan=$(tput setaf 6)
white=$(tput setaf 7)
gray=$(tput setaf 8)
orange=$(tput setaf 202)
purple=$(tput setaf 125)
violet=$(tput setaf 61)
light_red=$(tput setaf 9)
light_green=$(tput setaf 10)
light_yellow=$(tput setaf 11)
light_blue=$(tput setaf 12)
light_magenta=$(tput setaf 13)
light_cyan=$(tput setaf 14)
bright_white=$(tput setaf 15)

# dialog colors
REVERSE="\Zr"
UNDERLINE="\Zu"
BOLD="\Zb"
RESET="\Zn"
BLACK="\Z0"
YELLOW="\Z3"
AMARELO="\Zb\Z3"
WHITE="\Z7"
BLUE="\Z4"
AZUL="\Zb\Z4"
CYAN="\Z6"
RED="\Z1"
GREEN="\Z2"
MAGENTA="\Z5"

[[ -z "191" ]] && COLUMNS=52 191
COLUMNS=191
[[ "191" = "0" ]] && COLUMNS=80
COL=183
SET_COL="\033[183G" # at the 183 char
CURS_ZERO="\033[0G"
COL_NC='\e[0m' # No Color
COL_LIGHT_GREEN='\e[1;32m'
COL_LIGHT_RED='\e[1;31m'
TICK="[37m[\e[1;32m‚úì\e[0m[37m]"
CROSS="[37m[\e[1;31m‚úó\e[0m[37m]"
INFO="[i]"
# shellcheck disable=SC2034
DONE="\e[1;32m done!\e[0m"
OVER="\r\033[K"
DOTPREFIX="  [1m[30m::(B[m "

#debug
export PS4='${red}${0##*/}${green}[$FUNCNAME]${pink}[$LINENO]${reset}'
#set -x
#set -e
shopt -s extglob

#system
declare APP="${0##*/}"
declare _VERSION_="1.0.0-20250813"
declare APPDESC="bash - Wraper for "
declare distro="$(uname -n)"
declare DEPENDENCIES=(tput)
declare dialogRcFile="/home/vcatafesta/.dialogrc"

cleanup() { rm -f ""; }
#trap cleanup EXIT
MostraErro() { echo "erro: ${red}$1${reset} => comando: ${cyan}'$2'${reset} => result=${yellow}$3${reset}";}
trap 'MostraErro "$APP[$FUNCNAME][$LINENO]" "$BASH_COMMAND" "$?"; exit 1' ERR

sh_create_dialogrc() {
  cat > "$dialogRcFile" <<EOF_DIALOGRC
screen_color = (white,black,off)
dialog_color = (white,black,off)
title_color = (cyan,black,on)
border_color = dialog_color
shadow_color = (black,black,on)
button_inactive_color = dialog_color
button_key_inactive_color = dialog_color
button_label_inactive_color = dialog_color
button_active_color = (white,cyan,on)
button_key_active_color = button_active_color
button_label_active_color = (black,cyan,on)
tag_key_selected_color = (white,cyan,on)
item_selected_color = tag_key_selected_color
form_text_color = (BLUE,black,ON)
form_item_readonly_color = (green,black,on)
itemhelp_color = (white,cyan,off)
inputbox_color = dialog_color
inputbox_border_color = dialog_color
searchbox_color = dialog_color
searchbox_title_color = title_color
searchbox_border_color = border_color
position_indicator_color = title_color
menubox_color = dialog_color
menubox_border_color = border_color
item_color = dialog_color
tag_color = title_color
tag_selected_color = button_label_active_color
tag_key_color = button_key_inactive_color
check_color = dialog_color
check_selected_color = button_active_color
uarrow_color = screen_color
darrow_color = screen_color
form_active_text_color = button_active_color
gauge_color = title_color
border2_color = dialog_color
searchbox_border2_color = dialog_color
menubox_border2_color = dialog_color
separate_widget = ''
tab_len = 0
visit_items = off
use_shadow = off
use_colors = on
EOF_DIALOGRC
  export DIALOGRC="$dialogRcFile"
}

# Testa se o terminal suporta caracteres gr√°ficos estendidos
sh_ascii_lines() {
  #Isso for√ßa o dialog a usar caracteres ASCII b√°sicos para as bordas.
  #if [[ "$LANG" =~ 'UTF-8' ]]; then
  if [[ "$(printf '\u250C')" =~ "‚îå" ]]; then
    export NCURSES_NO_UTF8_ACS=1  # Terminal suporta ACS
  else
    export NCURSES_NO_UTF8_ACS=0  # Terminal N√ÉO suporta ACS
  fi
  }

sh_setEnvironment() {
  [[ ! -e "$dialogRcFile" ]] && sh_create_dialogrc
  sh_ascii_lines
}

sh_checkroot() {
  if [[ "1000" != "0" ]]; then
    #alerta " Linux installer" "\033[38;5;196mYou should run this script as root!"
    #scrend 0
    elevate_to_root "chili-create-zram-disk"
  fi
}

elevate_to_root() {
  log_err "This script must be run as root. Elevating privileges..."
  ccabec+='root [elevated]'
  # Tenta usar sudo primeiro (caso esteja configurado)
  if command -v sudo >/dev/null 2>&1; then
    exec sudo bash "bash" "chili-create-zram-disk"
  fi
  # Se sudo falhar, tenta su
  if command -v su >/dev/null 2>&1; then
    exec su -c "bash chili-create-zram-disk"
  fi
  die "Error: Unable to elevate privileges. Run manually as root."
}

log_ok() { echo -e "  [37m[\e[1;32m‚úì\e[0m[37m] chili-create-zram-disk(B[m"; }
log_err() { echo -e "  [37m[\e[1;31m‚úó\e[0m[37m] chili-create-zram-disk(B[m"; }

die() {
  local msg="chili-create-zram-disk"
  shift
  echo -e "  [37m[\e[1;31m‚úó\e[0m[37m] [1m[38;5;196m(B[m"
  exit 1
}

#!/usr/bin/env bash

# ========================================================
# Script: chili-create-zram-disk
# Descri√ß√£o: Cria zram como disco tempor√°rio com FS e compress√£o
# ========================================================

set -e

# ===== Cores =====
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# ===== Fun√ß√£o de uso =====
usage() {
  echo -e "${BLUE}Uso:${NC} $0 ${YELLOW}[-s SIZE] [-f FS] [-c COMPRESSION] [-m MOUNTPOINT]${NC}"
  echo -e "  ${YELLOW}-s SIZE${NC}         Tamanho do ZRAM, ex: ${GREEN}12G${NC} (padr√£o ${GREEN}12G${NC})"
  echo -e "  ${YELLOW}-f FS${NC}           Sistema de arquivos: ${GREEN}btrfs, ext4, xfs, jfs, exfat, ntfs${NC} (padr√£o ${GREEN}btrfs${NC})"
  echo -e "  ${YELLOW}-c COMPRESSION${NC}  Compress√£o para Btrfs: ${GREEN}zstd:N ou lzo${NC}, ignorado para ext4/xfs (padr√£o ${GREEN}zstd:3${NC})"
  echo -e "  ${YELLOW}-m MOUNTPOINT${NC}   Ponto de montagem (padr√£o ${GREEN}/mnt/zram_build${NC})"
  echo -e "  ${YELLOW}-h${NC}              Mostra esta ajuda"
  exit 1
}

# ===== Se nenhum argumento, mostra usage =====
if [ $# -eq 0 ]; then
  usage
fi

# ===== Par√¢metros padr√£o =====
SIZE="12G"
FS="btrfs"
COMP="zstd:3"
MOUNT="/mnt/zram_build"

# ===== Parse args =====
while getopts ":s:f:c:m:h" opt; do
  case $opt in
    s) SIZE="$OPTARG" ;;
    f) FS="$OPTARG" ;;
    c) COMP="$OPTARG" ;;
    m) MOUNT="$OPTARG" ;;
    h) usage ;;
    *) usage ;;
  esac
done

# ===== 1Ô∏è‚É£ Para temporariamente systemd-swap =====
echo -e "${YELLOW}Parando systemd-swap...${NC}"
sudo systemctl stop systemd-swap.service
sudo systemctl mask systemd-zram-setup@.service

# ===== 2Ô∏è‚É£ Limpa zram antigos =====
echo -e "${YELLOW}Limpando zram antigos...${NC}"
sudo swapoff /dev/zram* 2>/dev/null || true
for i in /dev/zram*; do
  sudo zramctl --reset "$i" 2>/dev/null || true
done
sudo modprobe -r zram || true

# ===== 3Ô∏è‚É£ Carrega m√≥dulo com 1 dispositivo =====
sudo modprobe zram num_devices=0 || true

# ===== 4Ô∏è‚É£ Detecta algoritmo suportado =====
if [ -e /sys/block/zram0/comp_algorithm ]; then
  ALG=$(grep -oE '\[[^]]+\]|lzo' /sys/block/zram0/comp_algorithm | head -n1 | tr -d '[]')
else
  ALG=lzo-rle
fi
echo -e "${BLUE}Algoritmo de compress√£o do ZRAM: ${GREEN}$ALG${NC}"

# ===== 5Ô∏è‚É£ Encontra dispositivo zram livre e configura =====
DEV=$(sudo zramctl --find)
if [ -z "$DEV" ]; then
  echo -e "${RED}Nenhum dispositivo ZRAM livre encontrado!${NC}"
  exit 1
fi
echo -e "${YELLOW}Configurando $DEV com $SIZE...${NC}"
sudo zramctl "$DEV" --size $(( $(numfmt --from=iec $SIZE) )) --algorithm "$ALG"

# ===== 6Ô∏è‚É£ Formata o FS =====
echo -e "${YELLOW}Formatando $DEV em $FS...${NC}"
case "$FS" in
  btrfs)
    sudo mkfs.btrfs -f "$DEV" -L ZRAM_BTRFS_12G
    ;;
  ext4)
    sudo mkfs.ext4 -F "$DEV" -L ZRAM_EXT4_12G
    ;;
  xfs)
    sudo mkfs.xfs -f "$DEV" -L ZRAM_XFS_12G
    ;;
  jfs)
    sudo mkfs.jfs -f "$DEV" -L ZRAM_JFS_12G
    ;;
  exfat)
    sudo mkfs.exfat -f "$DEV" -L EXFAT_12G
    ;;
  ntfs)
    sudo mkfs.ntfs --fast "$DEV" --enable-compression --no-indexing --label ZRAM_NTFS_12G
    ;;
  *)
    echo -e "${RED}Sistema de arquivos desconhecido: $FS${NC}"
    usage
    ;;
esac

# ===== 7Ô∏è‚É£ Monta o dispositivo =====
echo -e "${YELLOW}Montando $DEV em $MOUNT...${NC}"
sudo mkdir -p "$MOUNT"

if [ "$FS" = "btrfs" ]; then
  sudo mount -o noatime,nodiratime,nobarrier,ssd,commit=10,compress="$COMP" "$DEV" "$MOUNT"
else
  sudo mount "$DEV" "$MOUNT"
fi

echo -e "${GREEN}ZRAM pronto! Montado em $MOUNT com $FS${NC}"

